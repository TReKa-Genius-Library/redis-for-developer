## 캐싱 전략
### 읽기 전략 - look aside
- 애플리케이션에서 찾고자 하는 데이터를 캐시에 있는지 먼저 확인.
  - `cache hit` vs `cache miss`
- 캐시에 없으면 데이터베이스에 접근하여 가져온 후, 캐시에 저장
- 만약 레디스에 문제가 생긴다면?
  - cache hit ratio가 굉장히 높은 상황이었다면, 레디스에 문제 발생 시 모든 커넥션이 한꺼번에 원본 데이터베이스로 몰려 많은 부하 발생
    - 🙋🏻‍♂️: redis replication 해주는 것이 좋을 듯? 그래야 레디스 서버 하나가 문제 생겨도, 다른 레디스에서 처리해줄테니. 이후, 부하가 적은 시점에 문제생긴 레디스 쪽이랑 동기화해주고.
- 기존 애플리케이션에 레디스 투입할 때엔 cache warming 과정을 통해 캐시에 데이터를 채워주기

  
### 쓰기 전략 - write through
- DB 업데이트 시, 매번 캐시에도 데이터 업데이트
  - 데이터를 쓸 때 시간이 많이 걸림 
  - 다시 사용되지 않을 데이터도 무조건 업데이트 -> cache ttl 설정 권장 

### 쓰기 전략 - cache invalidation
- DB 업데이트 시, 캐시에는 데이터 삭제
  - write through는 캐시를 일부 업데이트하는 비용이 존재하지만, cache invalidation 전략은 캐시 삭제 후 재생성하는 전략이어서 비용이 적음.

### 쓰기 전략 - write behind (write back)
- 데이터 변경 시 캐시에 먼저 업데이트, 이후에 건수나 특정 시간 간격에 따라 비동기적으로 DB 업데이트
  - 성능 부하를 최소화할 수 있음.
  - 캐시에 문제가 생길 경우, 일정 기간동안의 데이터가 날아갈 위험성 존재 

## 캐시 만료
- 레디스는 만료된 키를 바로 삭제하지 않음. 이에 따라 삭제 리소스 감소하나, 메모리를 좀 더 차지할 수 있음. 최악의 경우 1/4는 만료된 키로 이루어질 수도 있음.
- passive 삭제: 키가 만료될 경우, 메모리에서 수동적으로 삭제
  - 사용자가 접근하는 경우에만 수동적으로 삭제되므로 passive 방식의 만료라고 부름.
  - 사용자가 다시 접근하지 않는 만료된 키도 존재하므로 충분치 않은 방식 
- active 삭제: TTL 값이 있는 키 중 20개 랜덤 추출 후, 만료된 키들 삭제.
  - 25% 이상의 키가 삭제된 경우 해당 과정 반복
  - 1초에 10번 수행 (0.1초당 한번 꼴)
 
## Cache Stampede 현상
- 레디스 특정 키가 만료된 상황에서, 여러 대의 서버에서 캐시를 읽어오지 못해 한꺼번에 DB에 가서 데이터를 `duplicate read` 한 후 레디스에 `duplicate write` 하는 현상.
- 또는, redis가 여러 대이거나 서버-캐시 데이터 불일치 등 캐시 정합성이 맞지 않는 경우에도 캐시 동기화 과정에서 발생할 수도 있음. [참고](https://www.thetechplatform.com/post/how-to-prevent-cache-stampede-thundering-herd-problems)
  - 서버 대수가 많을 수록 `duplicate read` 현상의 DB 부하는 심해질 수 있으며 이는 곧 서비스 이슈로 발생 가능
    - 🙋🏻‍♂️: 실제로 pinpoint에서 레이턴시가 튀는 현상에는 아래 상황들이 있는 거 같아요.
      1. 외부 API 또는 서버 timeout (ex. 쿠폰을 사용하기 위해 해당 회원 인증여부 확인을 위해 회원 API 찔렀으나 timeout)
      2. Connection 수 부족 또는 스레드 수 이슈
      3. 캐시 이슈 및 캐싱 전략 이슈 (흔하지는 않은 듯)
          - 실제로 cache stampede 현상으로 인해 장애가 난 케이스들이 여럿 회사에서 가끔씩 있는 것으로 알고 있습니다!      
- 개선 방안
  - TTL을 너무 짧지 않게 설정
    - DB에 지나치게 부하를 주는 현상을 피하기 위해
  - cache TTL보다 빠르게 cache put을 하는 방법으로 이를 막을 수 있음.
    - PER 알고리즘    
