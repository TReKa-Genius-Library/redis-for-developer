# 10. 클러스터

궁금해서 찾아본 내용들

> Q: 가십 프로토콜(GOSSIP PROTOCOL) 이란?  
> 즉, O(LogN)안에 네트워크의 노드들에 데이터를 전달할 수 있다  
https://medium.com/@heonjang.lee96/gossip-프로토콜이란-906500c3de4b

> Q: gossip message를 통한 장애 상황 전파  
> https://medium.com/@wellsy001012/redis-cluster의-gossip-message-장애-감지-failover-6541471c8c99

## 1. 레디스의 확장성
레디스는 단일 스레드로 동작하기 떄문에 서버에 CPU를 추가해도 여러 core를 동시에 활용할 수 없다.
그러나 데이터를 여러 서버로 분할해 관리하면 다수의 서버에서 요청을 병렬로 처리할 수 있으므로, 서버 대수를 늘림으로써 처리량을 확장시킬 수 있다.

## 2. 레디스의 클러스터
클러스터 모드 사용시 추가적인 변경 없이 레디스 인스턴스 간 수평 확장이 가능하다.

### 2.1) 샤딩
데이터 저장소를 수평 확장하며, 여러 서버 간에 데이터를 분할하는 DB 아키텍처 패턴을 샤딩이라 한다.
샤딩과 관련된 모든 기능은 레디스 내부에 자체적으로 관리되며, 이를 위한 추가 아키텍처는 필요 없다.

하나의 키는 하나의 마스터 노드에 매핑 -> 클라이언트가 특정 키를 갖고 다른곳에 쓰려하면 Redirection 시킨다
또한 노드가 추가/변경 되지 않는 이상, 특정 키가 어떤 마스터에 저장돼 있는지의 정보를 캐싱할 수 있다.

### 2.2) 고가용성
페일오버시 `클러스터 버스`라는 독립적인 통신을 사용하게 된다.

모든 노드들은 다른 레디스 클러스터와 통신하기 위한 TCP 포트가 열려있다.

클러스터는 모든 노드가 TCP 연결을 사용해 다른 모든 노드와 연결 돼 있는 `풀 메쉬 토폴로지` 형태다. 클러스터가 N개의 노드로 이뤄져 있을 때, 모든 노드는 N-1개의 다른 노드와 송수신 TCP를 연결하고 있으며, 이 연결은 계속 유지된다.

## 3. 레디스 클러스터 동작 방법
### 3.1) 해시슬롯을 이용한 데이터 샤딩
레디스는 총 16384개의 해시슬롯을 가지며, 마스터 노드는 해시슬롯을 나눠 갖고 있다.
\3대의 마스터 노드로 클러스터를 구성했을 때 다음과 같다
- MASTER-1 : 0 ~ 5460
- MASTER-2 : 5461 ~ 10922
- MASTER-3 : 10923 ~ 16383

레디스에 입력되는 모든 키는 하나의 해시슬롯에 매핑된다.

CRC16으로 암호화 한 후, 그 값을 16384로 나눈 나머지로 매핑시킨다.

### 3.2) 해시태그

키를 통해 값을 갖고올때, 서로 다른 해시슬롯에 저장되어 있다면 명령어 한번으로 갖고올수가 없다.
-> 커맨드를 처리할 마스터로 클라이언트의 연결을 리다이렉션 하기 때문

이럴때 `해시태그` 라는 기능을 사용한다!
- 다만 이 기능을 잘못 사용하면, 너무 많은 키가 하나의 해시슬롯에 몰릴 수 도 있다.

### 3.3) 자동 재구성
센티널과 달리 클러스터는!

> 별개의 센티널 인스턴스를 추가로 실행하는 것과 달리, 클러스터 구조에서는 데이터를 저장하는 일반 노드가 서로 감시한다

모든 노드는 클러스터 버스를 통해 통신하며, 인스턴스에 문제가 생겼을 때 자동으로 클러스터를 재구성 한다.

## 4. 클러스터 운영
### 4.1) 클러스터 리샤딩
마스터 노드가 가지고 있는 해시슬롯 중 일부를 다른 마스터로 이동시키는 것

### 4.2) 신규 노드 추가
신규로 추가될 레디스에 데이터가 저장되지 않은 상태여야 가능하다.

- --cluster add-node 사용시 클러스터에 신규 마스터 노드를 추가할 수 있다.
- `redis-cli --cluster add-node <추가할 노드 IP:PORT> <기존 노드 IP:PORT>`
- 이렇게 추가시 리샤딩 기능을 통해 직접 해시슬롯을 할당해야 데이터 저장 가능

복제본으로 추가하는 방식도 있는데 거의 유사하여 생략

### 4.3) 노드 제거
`redis-cli --cluster del-node <기존 노드 IP:PORT> <삭제할 노드 ID>`
- 삭제하려는 대상이 마스터, 복제본인지 상관없이 삭제할 수 있다.
- 삭제 전 노드에 저장된 데이터가 없어야 한다.

> CLUSTER FORGER : 클러스터 구성 데이터를 지우는 것 뿐만 아니라, 클러스터 내의 다른 노드들에게도 해당 노드의 정보를 지워야 한다. CLUSETER FORGET 커맨드를 수신한 노드는 해당 정보를 지운다.

> CLUSTER RESET : 제거될 노드에서 수행된다. 기본은 SOFT

### 4.5) 복제본을 이용한 읽기 성능 향상
복제본에서 값을 읽으려 해도 일반적으로는 불가능, 마스터에서 읽어야 함
`readonly`설정을 해줘야 가능해짐

