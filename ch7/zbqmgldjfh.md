# 7. 레디스 데이터 백업 방법

## 7.1 레디스에서 데이터를 영구 저장하기

`백업과 복제는 목적부터 다르다!`
복제는 가용성을 위한 것 이며, 백업은 장애 상황에서 데이터의 복구를 위해 필요하다.

레디스에서 데이터를 안전하게 저장하기 위해 레디스에서는 `RDB`와 `AOF` 두 가지의 백업 방식을 지원한다.
- `AOF`(Append only file) : 레디스 인스턴스가 처리한 모든 쓰기 작업을 차례대로 기록. 복원시에는 파일을 다시 읽어가며 데이터 새트 재구성
- `RDB`(Redis Database) : 일정 시점에 메모리에 저장된 데이터 전체를 저장 (snapshot 방식)

레디스에서 데이터를 복원할 수 있는 시점은 서버가 재시작될 때뿐이며, 레디스 인스턴스의 실행 도중에 데이터 파일을 읽어올 수 있는 방법은 없다.

## 7.2 RDB 방식의 데이터 백업
```
save <기간(초)> <기간 내 변경된 키의 개수>
save 60 10000
```
60초 동안 10,000 개 이상의 키가 변경되는 경우 RDB 파일을 저장한다는 명령어 이다!

- SAVE : 동기 방식의 RDB 파일 생성 방식 -> 클라이언트의 요청 차단됨
- BGSAVE : fork를 통해 자식 process를 생성하여 백그라운드에서 RDB 파일을 생성

복제를 사용할 경우에도 자동으로 RDB 파일을 생성한다.

## 7.3 AOF 방식의 데이터 백업
AOF는 레디스 인스턴스에 수행된 모든 쓰기 작업의 로그를 차례로 기록한다.
다만, 메모리에 영향을 끼치는 작업만 저장된다.
따라서 다음 명령어는 존재하지 않는 키를 삭제하는 작업이기 때문에 저장되지 않는다.
```
> DEL non_existing_key
(integer) 0
```

`appendonly` 옵션을 yes로 지정하면 AOF 파일에 주기적으로 데이터가 저장된다.

AOF는 실행되는 커맨드가 파일의 뒤쪽에 계속 추가되는 방식으로 동작한다.
따라서 인스턴스가 실행되는 시간에 비례하여 AOF 파일의 크기는 계속 증가하게 된다.

## 7.4 AOF 파일의 재구성
AOF는 파일이 계속 커치기 때문에 파일을 주기적으로 압축시키는 재구성 작업이 필요하다.

#### 버전7 이전까지 AOF파일은 하나로 관리되었다.
AOF 파일 앞부분에는 RDB 파일이 기록, 파일 뒤에는 RESP 형태로 RDB 파일의 뒤에 쌓이는 형태로 증가된다.

1) Redis는 Fork를 통해 자식 process를 생성
2) 자식 Process는 레디스의 메모리를 읽어와 신규로 생성한 임시 파일에 저장
3) 이 기간동안 레디스 메모리의 데이터가 변경된다면, 해당 내역은 AOF파일과 인메모리 버퍼에 동시에 저장된다.
4) 자식 Process에서의 재구성 과정이 끝나면 인메모리 버퍼에 저장된 내용을 임시파일의 끝에 추가한다.
5) 생성된 임시파일로 기존의 AOF 파일을 덮어 씌운다.

#### 버전7 이후부터는
AOF는 기본이 되는 바이너리 형태의 RDB 파일, 증가하는 RESP의 테스트 형태의 AOF 파일로 나눠서 데이터를 관리한다.
또한 현재 레디스가 바라보고있는 파일이 어떤 것인지 나타내는 매니페스트 파일을 추가적으로 도입했으며, 매니페스트 파일은 RDB와 AOF파일이 어떤 것인지 알려주는 역할을 한다.

1) Fork를 통해 자식 process를 생성
2)  자식 Process는 레디스의 메모리를 읽어와 신규로 생성한 임시 파일에 저장
3) 이 기간동안 레디스 메모리의 데이터가 변경된다면, 해당 내역은 신규 AOF파일에 저장된다.
4) AOF 재구성이 끝나면, 임시 매니페스트 파일을 생성한 뒤, 변경된 버전으로 매니페스트 파일의 내용을 업데이트
5) 기존 매니페스트 파일을 덮어 씌운 뒤, 이전 버전의 AOF, RDB 파일들 삭제


AOF 재구성 과정은 모두 순차 입출력만 사용하기 떄문에 디스크에 접근하는 모든 과정이 굉장히 효율적이란 것이다.

## 7.5 AOF 파일의 안전성
데이터를 파일에 저장할때 다음과 같이 진행
```
Redis -> OS BUFFER -> DISK 
```
WRITE 시스템 콜 호출시 OS 버퍼에 임시 저장한다. 이후 커널에 여유가 있거나, 지연시간인 30초에 도달하면 데이터를 실제 Disk로 보낸다.

Redis에서는`APPEDNFSYNC`옵션을 이용하면 FSYNC 호출을 제어할 수 있으며, 즉 파일 저장의 내구성을 제어할 수 있다.
- APPEDNFSYNC no : 커널 버퍼에 담기는거 까지만 확인
- APPEDNFSYNC always : 항상 write fsync 시스템 콜을 함께 호출. 매번 쓰고자 하는 데이터가 파일에 정확하게 저장되는 것
- APPEDNFSYNC everysec : 데이터를 저장 할 때 WRITE 시스템 콜을 호출하며, 1초에 한번씩 FSYNC 시스템 콜을 호출한다.

### 추가로, 백업사용시 항상 OOM을 주의하자!
레디스는 Copy-on-write를 이용하여 메모리 상의 데이터를 통으로 하나 더 복사하기 때문에 위험하다.
